<!DOCTYPE html>
<html lang="en">

<head>
    <title>surface plot</title>
    <meta charset="UTF-8" /> INSERT_JS_LIBRARIES_HERE
    <script>
        var surfaceMapInfo = INSERT_CONNECTOME_JSON_HERE;
        var data = [];

        function makePlot(surface, hemisphere, divId) {

            info = surfaceMapInfo[surface + "_" + hemisphere];
            info["type"] = "mesh3d";

            for (let attribute of ["x", "y", "z"]) {
                if (!(attribute in info)) {
                    info[attribute] = decodeBase64(
                        info["_" + attribute], "float32");
                }
            }
            for (let attribute of ["i", "j", "k"]) {
                if (!(attribute in info)) {
                    info[attribute] = decodeBase64(
                        info["_" + attribute], "int32");
                }
            }

            info["color"] = "#aaaaaa";
            info["opacity"] = $("#opacity-range").val() / 100;
            info['lighting'] = getLighting();
            data.push(info);

            let layout = getLayout("surface-plot", "select-view", false);
            let config = getConfig();

            Plotly.plot(divId, data, layout, config);
        }

        function addPlot() {

            for (let hemisphere of ["left", "right"]) {
                makePlot("pial", hemisphere, "surface-plot");
            }
            addColorbar(
                surfaceMapInfo["connectome"]["colorscale"],
                surfaceMapInfo["connectome"]["cmin"],
                surfaceMapInfo["connectome"]["cmax"],
                "surface-plot", getLayout("surface-plot", "select-view", false),
                getConfig());
        }

        function updateOpacity() {
            data[0]["opacity"] = $("#opacity-range").val() / 100;
            data[1]["opacity"] = $("#opacity-range").val() / 100;
            Plotly.react("surface-plot", data,
                         getLayout("surface-plot", "select-view", false),
                         getConfig());
        }

        function surfaceRelayout(){
            return updateLayout("surface-plot", "select-view", false);
        }

        function addConnectome() {
            let info = surfaceMapInfo["connectome"];

            for (let attribute of ["c_x", "c_y", "c_z", "c_c"]) {
                if (!(attribute in info)) {
                    info[attribute] = Array.from(decodeBase64(
                        info["_" + attribute], "float32"));
                    for (let i = 2; i < info[attribute].length; i += 3) {
                        info[attribute][i] = null;
                    }
                }
            }

            Plotly.plot('surface-plot', [{
                type: 'scatter3d',
                mode: 'lines+markers',
                x: info["c_x"],
                y: info["c_y"],
                z: info["c_z"],
                opacity: 1,
                line: {
                    width: 6,
                    color: info["c_c"],
                    colorscale: info["colorscale"],
                    cmin: info["cmin"],
                    cmax: info["cmax"]
                },
                marker: {
                    size: 3,
                    color: info["c_c"],
                    colorscale: [
                        [0, '#000000'],
                        [1, "#000000"]
                    ],
                }
            }]);

        }
    </script>
    <script>
        $(document).ready(
            function() {
                addPlot();
                addConnectome();
                $("#select-view").change(surfaceRelayout);
                $("#surface-plot").mouseup(function() {
                    $("#select-view").val("custom");
                });
                $(window).resize(surfaceRelayout);
                $("#opacity-range").change(updateOpacity);

            });
    </script>
</head>

<body>

    <div id="surface-plot"></div>
    <select id="select-view">
        <option value="left">view: Left</option>
        <option value="right">view: Right</option>
        <option value="front">view: Front</option>
        <option value="back">view: Back</option>
        <option value="top">view: Top</option>
        <option value="bottom">view: Bottom</option>
        <option value="custom">view: -</option>
    </select>
    <input id="opacity-range" type="range" min="0" max="100" value="10"></input>

</body>

</html>
